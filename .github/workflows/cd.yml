name: CD - Deploy to GCP VM

# 파이프라인 실행 조건: CI 워크플로우가 완료되었을 때 실행
on:
  workflow_run:
    workflows:
      - CI - Build and Push Docker Image # CI 단계가 성공적으로 완료되어야 실행
    types:
      - completed

jobs:
  deploy-to-gcp:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      # Step 1: GCP VM에 SSH 연결 및 Docker 이미지 배포
      - name: Deploy to GCP VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.GCP_SSH_PASSPHRASE }}
          script: |
            docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
            docker stop notice-service || true
            docker rm notice-service || true
            docker pull ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
            docker run -d --name notice-service -p 80:8080 ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest